---
description: Where validation lives (services), and how to normalize API-friendly inputs
alwaysApply: true
---

## Validation (API/server)

- **Primary location**: Validation belongs in `src/server/services/*Service.ts` via `AbstractService.validate(data, isUpdate)`.
  - use `isUpdate` to make fields required on create and optional on patch
  - throw `ValidationError` with a clear, user-fixable message
- **Normalize API-friendly shapes**:
  - accept simple foreign keys like `customer_id` and translate to Prisma relations (`customer: { connect: { id } }`)
  - if a FK is explicitly set to `null` on PATCH, use relation `{ disconnect: true }` when supported
  - remove raw `*_id` fields before calling Prisma create/update when using “checked” inputs
- **Type coercion rules**:
  - date strings should be converted to `Date` before persisting (or rejected if invalid)
  - decimal-like numeric fields may accept `number | string | Prisma.Decimal`, normalize to `Prisma.Decimal`, and validate non-negative/finite constraints
- **String hygiene**: trim user-provided strings, reject empty strings, and enforce max lengths (generally 255 unless schema dictates otherwise).
