---
description: DomainError-based error handling for API + Prisma layers
alwaysApply: true
---

## Error handling (server/API)

- **Use domain errors**: server code should throw `DomainError` subclasses from `src/server/base/types.ts`:
  - `ValidationError` → 400
  - `NotFoundError` → 404
  - `ConflictError` → 409
  - `BusinessLogicError` → 422
  - `DatabaseError` → 500
- **Centralize responses in controllers**: API controllers should `catch (error)` and return `this.errorResponse(error)` (from `AbstractController`), not ad-hoc `NextResponse.json(...)`.
- **Consistent error JSON shape**: `errorResponse()` returns:
  - `{ error: <DomainErrorCode>, message: string, meta?: object }` for domain errors
  - `{ error: "INTERNAL_ERROR", message: string }` for unknown errors
- **Repository boundary**: Prisma exceptions should be translated in `AbstractRepository.handlePrismaError()` (e.g. P2002 → `ConflictError`, P2025 → `NotFoundError`). Don’t leak raw Prisma errors to callers.
