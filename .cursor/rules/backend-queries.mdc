---
description: Prisma query conventions (repositories, transactions, includes/selects)
alwaysApply: true
---

## Database queries (Prisma)

- **Repository-first**: Prefer `src/server/repositories/*Repository.ts` (extending `AbstractRepository`) for all Prisma access. Avoid ad-hoc `getPrisma()` calls in controllers.
- **Service owns orchestration**: Use services to compose multiple repository calls, and use `AbstractService.withTransaction()` for multi-step writes that must be atomic.
- **Avoid N+1**: If a response needs relations, pass `include`/`select` options through repository/service calls (and optionally support an `expanded=true` query param at the controller level).
- **Filter safety**: Build Prisma `where` filters from allowlisted query params; for text filters use `{ contains: value, mode: "insensitive" }`.
- **Donâ€™t write raw SQL**: Use Prisma methods; if raw SQL is unavoidable, keep it centralized and parameterized (never string-interpolate user input).
