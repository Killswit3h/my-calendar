generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Calendar {
  id         String       @id
  name       String
  isPrivate  Boolean      @default(true)
  createdAt  DateTime     @default(now())
  Event      Event[]
  ShareToken ShareToken[]
  Todo       Todo[]
}

model Certification {
  id            String    @id
  employeeName  String
  certification String
  status        String
  expiresOn     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now())

  @@index([status, expiresOn], map: "Certification_status_expires_idx")
}

model ChangeOrder {
  id          String    @id
  project     String
  title       String
  amount      Decimal?  @db.Decimal(12, 2)
  status      String
  submittedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now())

  @@index([project, status])
}

model Customer {
  id        String   @id
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime
  projects  Project[]
  events    Event[]
}

model Project {
  id         String    @id @default(cuid())
  name       String
  customerId String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @default(now()) @updatedAt
  customer   Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  events     Event[]

  @@index([customerId])
  @@unique([name, customerId])
}

model DailyReportSnapshot {
  id          String   @id
  reportDate  DateTime
  vendor      String?
  payloadJson String
  createdAt   DateTime @default(now())

  @@index([reportDate, vendor])
}

model Event {
  id                   String                 @id
  calendarId           String
  projectId            String?
  customerId           String?
  title                String
  description          String?
  allDay               Boolean                @default(false)
  location             String?
  employees            Json?
  invoiceNumber        String?
  type                 String?
  shift                WorkShift?
  checklist            Json?
  startsAt             DateTime               @db.Timestamptz(6)
  endsAt               DateTime               @db.Timestamptz(6)
  attachmentData       Bytes?
  attachmentName       String?
  attachmentType       String?
  Calendar             Calendar               @relation(fields: [calendarId], references: [id])
  project              Project?               @relation(fields: [projectId], references: [id])
  customer             Customer?              @relation(fields: [customerId], references: [id])
  assignments          EventAssignment[]
  EventQuantity        EventQuantity[]
  InventoryCheckout    InventoryCheckout[]
  InventoryReservation InventoryReservation[]
  laborDailyRows       LaborDaily[]

  @@index([calendarId, startsAt])
  @@index([endsAt])
  @@index([projectId])
  @@index([customerId])
}

model Employee {
  id             String            @id
  name           String?
  active         Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  defaultSection PlacementType?    @default(YARD_SHOP)
  hourlyRate     Decimal?          @db.Decimal(10, 2)
  assignments    EventAssignment[]
  hourlyRates    HourlyRate[]
  laborDailyRows LaborDaily[]
  placements     Placement[]
}

model Placement {
  id         String        @id @default(cuid())
  employeeId String
  dayKey     String
  placement  PlacementType
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  employee   Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, dayKey], name: "employeeId_dayKey")
  @@index([dayKey])
  @@index([placement])
}

model EventQuantity {
  id          String   @id
  eventId     String
  payItemId   String
  quantity    Decimal  @db.Decimal(18, 6)
  stationFrom String?
  stationTo   String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  PayItem     PayItem  @relation(fields: [payItemId], references: [id])

  @@index([eventId])
  @@index([payItemId])
}

model Holiday {
  id          String   @id
  date        DateTime
  localName   String
  name        String
  countryCode String
  regions     String?
  types       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@unique([date, countryCode])
}

model InventoryCategory {
  id            String          @id
  name          String
  slug          String          @unique
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  InventoryItem InventoryItem[]
}

model InventoryCheckout {
  id                                                                    String                  @id
  itemId                                                                String
  qty                                                                   Int
  fromLocationId                                                        String
  toEmployeeId                                                          String?
  toEventId                                                             String?
  toLocationId                                                          String?
  dueAt                                                                 DateTime?
  checkedOutById                                                        String
  checkedOutAt                                                          DateTime                @default(now())
  status                                                                InventoryCheckoutStatus @default(OPEN)
  closedAt                                                              DateTime?
  InventoryLocation_InventoryCheckout_fromLocationIdToInventoryLocation InventoryLocation       @relation("InventoryCheckout_fromLocationIdToInventoryLocation", fields: [fromLocationId], references: [id])
  InventoryItem                                                         InventoryItem           @relation(fields: [itemId], references: [id])
  Event                                                                 Event?                  @relation(fields: [toEventId], references: [id])
  InventoryLocation_InventoryCheckout_toLocationIdToInventoryLocation   InventoryLocation?      @relation("InventoryCheckout_toLocationIdToInventoryLocation", fields: [toLocationId], references: [id])
  InventoryReturn                                                       InventoryReturn[]

  @@index([itemId])
  @@index([toEventId])
}

model InventoryItem {
  id                   String                 @id
  sku                  String                 @unique
  name                 String
  description          String?
  unit                 String
  isConsumable         Boolean                @default(false)
  minStock             Int                    @default(0)
  barcode              String?                @unique
  categoryId           String?
  defaultLocationId    String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  deletedAt            DateTime?
  InventoryCheckout    InventoryCheckout[]
  InventoryCategory    InventoryCategory?     @relation(fields: [categoryId], references: [id])
  InventoryLocation    InventoryLocation?     @relation(fields: [defaultLocationId], references: [id])
  InventoryLedger      InventoryLedger[]
  InventoryReservation InventoryReservation[]
  InventoryStock       InventoryStock[]
  transfers            InventoryTransfer[]

  @@index([name])
}

model InventoryLedger {
  id                                                                  String                @id
  itemId                                                              String
  deltaQty                                                            Int
  fromLocationId                                                      String?
  toLocationId                                                        String?
  reason                                                              InventoryLedgerReason
  refType                                                             String?
  refId                                                               String?
  actorId                                                             String?
  at                                                                  DateTime              @default(now())
  notes                                                               String?
  InventoryLocation_InventoryLedger_fromLocationIdToInventoryLocation InventoryLocation?    @relation("InventoryLedger_fromLocationIdToInventoryLocation", fields: [fromLocationId], references: [id])
  InventoryItem                                                       InventoryItem         @relation(fields: [itemId], references: [id])
  InventoryLocation_InventoryLedger_toLocationIdToInventoryLocation   InventoryLocation?    @relation("InventoryLedger_toLocationIdToInventoryLocation", fields: [toLocationId], references: [id])

  @@index([itemId, at])
}

model InventoryLocation {
  id                                                                    String              @id
  name                                                                  String
  code                                                                  String              @unique
  isTruck                                                               Boolean             @default(false)
  createdAt                                                             DateTime            @default(now())
  updatedAt                                                             DateTime
  InventoryCheckout_InventoryCheckout_fromLocationIdToInventoryLocation InventoryCheckout[] @relation("InventoryCheckout_fromLocationIdToInventoryLocation")
  InventoryCheckout_InventoryCheckout_toLocationIdToInventoryLocation   InventoryCheckout[] @relation("InventoryCheckout_toLocationIdToInventoryLocation")
  InventoryItem                                                         InventoryItem[]
  InventoryLedger_InventoryLedger_fromLocationIdToInventoryLocation     InventoryLedger[]   @relation("InventoryLedger_fromLocationIdToInventoryLocation")
  InventoryLedger_InventoryLedger_toLocationIdToInventoryLocation       InventoryLedger[]   @relation("InventoryLedger_toLocationIdToInventoryLocation")
  InventoryReturn                                                       InventoryReturn[]
  InventoryStock                                                        InventoryStock[]
  transfersFrom                                                         InventoryTransfer[] @relation("TransferFrom")
  transfersTo                                                           InventoryTransfer[] @relation("TransferTo")
}

model InventoryReservation {
  id            String        @id
  itemId        String
  eventId       String
  qty           Int
  neededAt      DateTime
  notes         String?
  createdAt     DateTime      @default(now())
  Event         Event         @relation(fields: [eventId], references: [id])
  InventoryItem InventoryItem @relation(fields: [itemId], references: [id])

  @@index([eventId])
  @@index([itemId, neededAt])
}

model InventoryReturn {
  id                String            @id
  checkoutId        String
  qty               Int
  toLocationId      String
  condition         String?
  notes             String?
  photoUrl          String?
  checkedInById     String
  checkedInAt       DateTime          @default(now())
  InventoryCheckout InventoryCheckout @relation(fields: [checkoutId], references: [id])
  InventoryLocation InventoryLocation @relation(fields: [toLocationId], references: [id])

  @@index([checkoutId])
}

model InventoryStock {
  id                String            @id
  itemId            String
  locationId        String
  qty               Int               @default(0)
  updatedAt         DateTime
  InventoryItem     InventoryItem     @relation(fields: [itemId], references: [id])
  InventoryLocation InventoryLocation @relation(fields: [locationId], references: [id])

  @@unique([itemId, locationId])
  @@index([locationId])
}

model InventoryTransfer {
  id             String            @id
  itemId         String
  fromLocationId String
  toLocationId   String
  qty            Int
  status         String
  requestedAt    DateTime          @default(now())
  fulfilledAt    DateTime?
  notes          String?
  fromLocation   InventoryLocation @relation("TransferFrom", fields: [fromLocationId], references: [id])
  item           InventoryItem     @relation(fields: [itemId], references: [id])
  toLocation     InventoryLocation @relation("TransferTo", fields: [toLocationId], references: [id])

  @@index([itemId])
  @@index([status])
}

model PayItem {
  id            String          @id
  number        String          @unique
  description   String
  unit          String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  EventQuantity EventQuantity[]
}

model PurchaseOrder {
  id         String    @id
  poNumber   String    @unique
  project    String
  vendor     String
  status     String
  expectedOn DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @default(now())

  @@index([status])
}

model ReportFile {
  id         String     @id
  kind       ReportKind
  reportDate DateTime?
  weekStart  DateTime?
  weekEnd    DateTime?
  vendor     String?
  blobUrl    String
  bytes      Int
  createdAt  DateTime   @default(now())

  @@index([reportDate, vendor])
  @@index([weekStart, weekEnd, vendor], map: "ReportFile_week_vendor_idx")
}

model Rfi {
  id         String    @id
  project    String
  subject    String
  assignedTo String?
  status     String
  dueDate    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @default(now())

  @@index([project, status])
}

model ShareToken {
  id         String    @id
  calendarId String
  role       ShareRole
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  Calendar   Calendar  @relation(fields: [calendarId], references: [id], onDelete: Cascade)
}

model Todo {
  id         String    @id @default(cuid())
  calendarId String
  title      String
  notes      String?
  done       Boolean   @default(false)
  type       EventType
  createdAt  DateTime  @default(now())
  Calendar   Calendar  @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  @@index([calendarId, createdAt])
}

model UserSetting {
  id           String  @id
  userId       String  @unique
  showHolidays Boolean @default(true)
  countryCode  String  @default("US")
  useIcs       Boolean @default(false)
  icsUrl       String?
}

model Vehicle {
  id            String    @id
  unit          String
  status        String
  location      String?
  nextServiceOn DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now())

  @@index([nextServiceOn], map: "Vehicle_nextService_idx")
  @@index([status])
}

model WeeklyReportRequest {
  id         String       @id
  weekStart  DateTime
  weekEnd    DateTime
  vendor     String?
  status     WeeklyStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  finishedAt DateTime?
  errorText  String?

  @@index([weekStart, weekEnd, vendor], map: "WeeklyReportRequest_week_vendor_idx")
}

model EventAssignment {
  id          String    @id @default(cuid())
  eventId     String
  employeeId  String
  dayOverride DateTime? @db.Date
  hours       Decimal?  @db.Decimal(4, 2)
  note        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, employeeId, dayOverride], map: "EventAssignment_event_employee_day_key")
  @@index([employeeId, dayOverride], map: "EventAssignment_employee_day_idx")
  @@index([eventId, dayOverride], map: "EventAssignment_event_day_idx")
}

model HourlyRate {
  id            String   @id @default(cuid())
  employeeId    String
  effectiveDate DateTime @db.Date
  rate          Decimal  @db.Decimal(10, 2)
  createdAt     DateTime @default(now())
  employee      Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, effectiveDate], map: "HourlyRate_employee_effective_date_key")
  @@index([effectiveDate], map: "HourlyRate_effective_idx")
}

model LaborDaily {
  id              String   @id @default(cuid())
  jobId           String
  jobName         String
  day             DateTime @db.Date
  eventId         String
  eventTitle      String?
  employeeId      String
  employeeName    String
  assignmentId    String?
  hoursDecimal    Decimal  @db.Decimal(6, 2)
  regularHours    Decimal  @db.Decimal(6, 2)
  overtimeHours   Decimal  @db.Decimal(6, 2)
  rateUsd         Decimal  @db.Decimal(10, 2)
  regularCostUsd  Decimal  @db.Decimal(12, 2)
  overtimeCostUsd Decimal  @db.Decimal(12, 2)
  totalCostUsd    Decimal  @db.Decimal(12, 2)
  note            String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: NoAction)
  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([day, eventId, employeeId], map: "LaborDaily_unique_row")
  @@index([employeeId, day], map: "LaborDaily_employee_day_idx")
  @@index([jobId, day], map: "LaborDaily_job_day_idx")
}

model fdot_cutoffs {
  id          String   @id
  year        Int
  cutoff_date DateTime
  label       String?
  created_by  String?
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now())

  @@unique([year, cutoff_date])
}

enum PlacementType {
  FREE
  YARD_SHOP
  NO_WORK
}

enum EventType {
  GUARDRAIL
  FENCE
  TEMP_FENCE
  HANDRAIL
  ATTENUATOR
}

enum InventoryCheckoutStatus {
  OPEN
  CLOSED
  LOST
  DAMAGED
}

enum InventoryLedgerReason {
  CHECKOUT
  RETURN
  ADJUST
  CONSUME
  TRANSFER
}

enum ReportKind {
  DAILY_PDF
  DAILY_XLSX
  WEEKLY_PDF
}

enum ShareRole {
  VIEWER
  EDITOR
}

enum WeeklyStatus {
  PENDING
  SUCCESS
  ERROR
}

enum WorkShift {
  DAY
  NIGHT
}

/// === Planner namespace: add below your existing models ===

model PlannerPlan {
  id          String            @id @default(cuid())
  name        String
  description String?
  color       String?           // hex accent for header
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  buckets     PlannerBucket[]
  tasks       PlannerTask[]   // convenience
  labels      PlannerLabel[]
  activity    PlannerActivity[]
}

model PlannerBucket {
  id        String   @id @default(cuid())
  planId    String
  name      String
  order     Int
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  plan      PlannerPlan  @relation(fields: [planId], references: [id], onDelete: Cascade)
  tasks     PlannerTask[]

  @@index([planId, order])
}

model PlannerTask {
  id          String   @id @default(cuid())
  planId      String
  bucketId    String
  title       String
  description String?
  priority    PlannerTaskPriority @default(MEDIUM)
  progress    PlannerTaskProgress @default(NOT_STARTED)
  startAt     DateTime?
  dueAt       DateTime?
  completedAt DateTime?
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  plan        PlannerPlan   @relation(fields: [planId], references: [id], onDelete: Cascade)
  bucket      PlannerBucket @relation(fields: [bucketId], references: [id], onDelete: Cascade)

  labels      PlannerTaskLabelOnTask[]
  assignees   PlannerTaskAssignment[]
  checklist   PlannerChecklistItem[]
  attachments PlannerAttachment[]
  comments    PlannerComment[]
  activity    PlannerActivity[]

  @@index([planId, bucketId, order])
}

enum PlannerTaskPriority {
  URGENT
  IMPORTANT
  MEDIUM
  LOW
}

enum PlannerTaskProgress {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model PlannerLabel {
  id      String @id @default(cuid())
  planId  String
  name    String
  color   String
  plan    PlannerPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  tasks   PlannerTaskLabelOnTask[]

  @@unique([planId, name])
}

model PlannerTaskLabelOnTask {
  taskId  String
  labelId String
  task    PlannerTask  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  label   PlannerLabel @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([taskId, labelId])
}

model PlannerTaskAssignment {
  id     String @id @default(cuid())
  taskId String
  userId String
  task   PlannerTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
}

model PlannerChecklistItem {
  id     String @id @default(cuid())
  taskId String
  title  String
  done   Boolean @default(false)
  order  Int
  task   PlannerTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model PlannerAttachment {
  id        String   @id @default(cuid())
  taskId    String
  name      String
  url       String
  mimeType  String?
  sizeBytes Int?
  createdAt DateTime @default(now())
  task      PlannerTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model PlannerComment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  body      String
  createdAt DateTime @default(now())
  task      PlannerTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model PlannerActivity {
  id        String   @id @default(cuid())
  planId    String
  taskId    String?
  userId    String
  type      String   // "TASK_CREATED","MOVED_BUCKET","UPDATED_TITLE", etc.
  meta      Json?
  createdAt DateTime @default(now())
  plan      PlannerPlan  @relation(fields: [planId], references: [id], onDelete: Cascade)
  task      PlannerTask? @relation(fields: [taskId], references: [id], onDelete: Cascade)
}
