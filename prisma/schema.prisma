generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Customer {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Calendar {
  id          String       @id @default(cuid())
  name        String
  isPrivate   Boolean      @default(true)
  createdAt   DateTime     @default(now())
  events      Event[]
  shareTokens ShareToken[]
  todos       Todo[]
}

model Event {
  id             String          @id @default(cuid())
  calendarId     String
  title          String
  description    String?
  allDay         Boolean         @default(false)
  location       String?
  employees      Json?
  invoiceNumber  String?
  type           String?
  shift          WorkShift?
  checklist      Json?
  startsAt       DateTime
  endsAt         DateTime
  attachmentData Bytes?
  attachmentName String?
  attachmentType String?
  calendar       Calendar        @relation(fields: [calendarId], references: [id])
  quantities     EventQuantity[]

  @@index([calendarId, startsAt])
  @@index([endsAt])
  @@map("Event")
}

model PayItem {
  id          String          @id @default(cuid())
  number      String          @unique
  description String
  unit        String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  quantities  EventQuantity[]
}

model EventQuantity {
  id          String   @id @default(cuid())
  eventId     String
  payItemId   String
  quantity    Decimal  @db.Decimal(18, 6)
  stationFrom String?
  stationTo   String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  payItem     PayItem  @relation(fields: [payItemId], references: [id])

  @@index([eventId])
  @@index([payItemId])
}

model Todo {
  id         String    @id @default(cuid())
  calendarId String
  title      String
  notes      String?
  done       Boolean   @default(false)
  type       EventType
  createdAt  DateTime  @default(now())
  calendar   Calendar  @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  @@index([calendarId, createdAt])
}

model ShareToken {
  id         String    @id @default(cuid())
  calendarId String
  role       ShareRole
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  calendar   Calendar  @relation(fields: [calendarId], references: [id], onDelete: Cascade)
}

model Holiday {
  id          String   @id @default(cuid())
  date        DateTime
  localName   String
  name        String
  countryCode String
  regions     String?
  types       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([date, countryCode])
}

model UserSetting {
  id           String  @id @default(cuid())
  userId       String  @unique
  showHolidays Boolean @default(true)
  countryCode  String  @default("US")
  useIcs       Boolean @default(false)
  icsUrl       String?
}

model ReportFile {
  id         String     @id @default(cuid())
  kind       ReportKind
  reportDate DateTime?
  weekStart  DateTime?
  weekEnd    DateTime?
  vendor     String?
  blobUrl    String
  bytes      Int
  createdAt  DateTime   @default(now())

  @@index([reportDate, vendor])
  @@index([weekStart, weekEnd, vendor], map: "ReportFile_week_vendor_idx")
}

model DailyReportSnapshot {
  id          String   @id @default(cuid())
  reportDate  DateTime
  vendor      String?
  payloadJson String
  createdAt   DateTime @default(now())

  @@index([reportDate, vendor])
}

model WeeklyReportRequest {
  id         String       @id @default(cuid())
  weekStart  DateTime
  weekEnd    DateTime
  vendor     String?
  status     WeeklyStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  finishedAt DateTime?
  errorText  String?

  @@index([weekStart, weekEnd, vendor], map: "WeeklyReportRequest_week_vendor_idx")
}

model FdotCutoff {
  id         String   @id @default(cuid())
  year       Int
  cutoffDate DateTime @map("cutoff_date")
  label      String?
  createdBy  String?  @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")

  @@unique([year, cutoffDate])
  @@map("fdot_cutoffs")
}

enum ShareRole {
  VIEWER
  EDITOR
}

enum EventType {
  GUARDRAIL
  FENCE
  TEMP_FENCE
  HANDRAIL
  ATTENUATOR
}

enum WorkShift {
  DAY
  NIGHT
}

enum ReportKind {
  DAILY_PDF
  DAILY_XLSX
  WEEKLY_PDF
}

enum WeeklyStatus {
  PENDING
  SUCCESS
  ERROR
}
